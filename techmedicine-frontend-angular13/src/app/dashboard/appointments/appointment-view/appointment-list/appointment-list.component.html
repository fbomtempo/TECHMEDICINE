<div *ngIf="appointments$ | async as appointments; else loadingError">
  <button
    type="button"
    class="btn btn-secondary mb-3"
    (click)="isCollapsed = !isCollapsed"
    [attr.aria-expanded]="!isCollapsed"
    aria-controls="collapseBasic"
  >
    Filtros <i class="fas fa-arrows-alt-v"></i>
  </button>
  <div id="collapseBasic" [collapse]="isCollapsed" [isAnimated]="true">
    <div class="row">
      <div class="col-12 pt-2 pb-3">
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            id="opened-filter-switch"
            [(ngModel)]="filterSwitches.opened"
          />
          <label class="form-check-label" for="opened-filter-switch"
            >Mostrar Agendados</label
          >
        </div>
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            id="cancelled-filter-switch"
            [(ngModel)]="filterSwitches.cancelled"
          />
          <label class="form-check-label" for="cancelled-filter-switch"
            >Mostrar Cancelados</label
          >
        </div>
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            id="finished-filter-switch"
            [(ngModel)]="filterSwitches.finished"
          />
          <label class="form-check-label" for="finished-filter-switch"
            >Mostrar Finalizados</label
          >
        </div>
        <div class="row pt-4">
          <div class="col-xl-6 col-lg-8 col-md-8 col-sm-12 col-xs-12">
            <label for="medic" class="form-label">Médico:</label>
            <ng-select
              [items]="medics"
              (change)="setFilterMedic($event)"
              bindLabel="searchLabel"
              labelForId="medic"
              placeholder="Selecione o médico"
              clearAllText="Limpar"
              [compareWith]="compareFnMedic"
              [loading]="medicsLoading"
              notFoundText="Nenhum item encontrado"
              [virtualScroll]="true"
            >
              <ng-template ng-label-tmp let-item="item">
                {{ item.name + " " + item.surname }}
              </ng-template>
              <ng-template
                ng-option-tmp
                let-item="item"
                let-index="index"
                let-search="searchTerm"
              >
                <div style="margin: 10px 0" class="card">
                  <div class="card-body">
                    <h5 class="card-title">
                      {{ item.name + " " + item.surname }}
                    </h5>
                    <h6 class="card-subtitle mb-2 text-muted">
                      CPF: {{ item.cpf }}
                    </h6>
                    <h6 class="card-subtitle mb-2 text-muted">
                      Telefone: {{ item.mobilePhone }}
                    </h6>
                  </div>
                </div>
              </ng-template>
            </ng-select>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row pt-3">
    <div class="col-xl-6 col-lg-8 col-md-8 col-sm-12 col-xs-12 mt-md-0 mt-2">
      <div class="d-flex">
        <input
          class="form-control"
          type="search"
          placeholder="Digite o nome do paciente"
          aria-label="Search"
          id="search"
          [(ngModel)]="filter"
        />
        <button
          type="button"
          class="btn btn-clear clear ms-2"
          (click)="filter = ''"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="col text-md-end text-sm-start text-start pt-md-0 pt-sm-4 pt-4">
      <a type="button" class="btn btn-primary" [routerLink]="['novo']"
        >Novo Agendamento <i class="fas fa-plus-circle"></i
      ></a>
    </div>
  </div>
  <div class="table-responsive">
    <table class="mt-3 table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">ID</th>
          <th scope="col">Paciente</th>
          <th scope="col">Médico</th>
          <th scope="col">Data Agendada</th>
          <th scope="col">Horário Marcado</th>
          <th scope="col">Situação</th>
          <th scope="col">Ações</th>
          <th></th>
        </tr>
      </thead>
      <tbody class="table-link">
        <tr
          *ngFor="
            let appointment of showData(appointments)
              | pagination: page:itemsPerPage;
            let i = index
          "
        >
          <th scope="row">{{ i + 1 + (page - 1) * itemsPerPage }}</th>
          <td>{{ appointment.id }}</td>
          <td>
            {{ appointment.patient.name + " " + appointment.patient.surname }}
          </td>
          <td>
            {{ appointment.medic.name + " " + appointment.medic.surname }}
          </td>
          <td>{{ appointment.scheduledDate }}</td>
          <td>{{ appointment.startTime + "-" + appointment.endTime }}</td>
          <td>
            <span
              class="appointment-label"
              [ngClass]="
                situationLabelBackground(appointment.appointmentSituation)
              "
              >{{ appointment.appointmentSituation }}</span
            >
          </td>
          <td>
            <div class="d-flex">
              <button
                *ngIf="appointment.appointmentSituation === 'AGENDADO'"
                type="button"
                title="Editar"
                class="btn btn-round btn-outline-edit me-2"
                [routerLink]="['editar/', appointment.id]"
              >
                <i class="fas fa-pencil-alt"></i>
              </button>
              <button
                *ngIf="appointment.appointmentSituation === 'AGENDADO'"
                type="button"
                title="Deletar"
                class="btn-round btn-outline-delete me-2"
                (click)="onDelete(appointment)"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
              <button
                type="button"
                title="Visualizar"
                class="btn-round btn-outline-view me-2"
                [routerLink]="['visualizar/', appointment.id]"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </td>
          <td>
            <button
              *ngIf="appointment.appointmentSituation === 'AGENDADO'"
              class="btn btn-outline-success"
              [routerLink]="['/atendimentos/novo']"
              [queryParams]="{ agendamento: appointment.id }"
            >
              Criar Atendimento <i class="fas fa-external-link-alt"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="mb-3 d-flex justify-content-center">
    <pagination
      [totalItems]="showData(appointments).length"
      [maxSize]="paginationSize"
      [itemsPerPage]="itemsPerPage"
      (pageChanged)="pageChanged($event)"
      [(ngModel)]="currentPage"
      [boundaryLinks]="true"
      previousText="&lsaquo;"
      nextText="&rsaquo;"
      firstText="&laquo;"
      lastText="&raquo;"
    >
    </pagination>
    <br />
  </div>
</div>

<ng-template #loadingError>
  <div *ngIf="error | async; else loading">
    <div
      style="height: 80vh"
      class="d-flex flex-column align-items-center justify-content-center"
    >
      <p style="font-size: 1.65rem">Erro ao carregar agendamentos.</p>
      <button
        type="button"
        class="btn btn-lg btn-secondary"
        (click)="reloadPage()"
      >
        Tentar Novamente <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #loading>
  <div
    style="height: 80vh"
    class="d-flex align-items-center justify-content-center"
  >
    <div class="loader"></div>
  </div>
</ng-template>
